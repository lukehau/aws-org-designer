name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create GitHub Release with auto-generated notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create ${{ github.ref_name }} --generate-notes --draft=false

  deploy-web:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ap-southeast-2

      - name: Trigger Amplify deployment
        id: start-job
        run: |
          RESPONSE=$(aws amplify start-job --app-id ${{ vars.AMPLIFY_APP_ID }} --branch-name main --job-type RELEASE)
          JOB_ID=$(echo $RESPONSE | jq -r '.jobSummary.jobId')
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Started Amplify job: $JOB_ID"

      - name: Wait for Amplify deployment
        run: |
          JOB_ID="${{ steps.start-job.outputs.job_id }}"
          APP_ID="${{ vars.AMPLIFY_APP_ID }}"
          echo "Waiting for job $JOB_ID to complete..."
          
          while true; do
            STATUS=$(aws amplify get-job --app-id $APP_ID --branch-name main --job-id $JOB_ID --query 'job.summary.status' --output text)
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "SUCCEED" ]; then
              echo "Amplify deployment succeeded"
              exit 0
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "::group::Amplify Build Logs"
              aws amplify get-job --app-id $APP_ID --branch-name main --job-id $JOB_ID --query 'job.steps[*].{step:stepName,status:status,logUrl:logUrl}' --output table
              echo ""
              echo "Fetching detailed logs for failed steps..."
              STEPS=$(aws amplify get-job --app-id $APP_ID --branch-name main --job-id $JOB_ID --query 'job.steps[?status==`FAILED`].logUrl' --output text)
              for LOG_URL in $STEPS; do
                echo "--- Log from: $LOG_URL ---"
                curl -s "$LOG_URL" | tail -100
                echo ""
              done
              echo "::endgroup::"
              echo "Amplify deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep 15
          done

  release-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install

      - name: Build and release for macOS
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run electron:release:mac

  release-win:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          Remove-Item -Force package-lock.json -ErrorAction SilentlyContinue
          npm install

      - name: Build and release for Windows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run electron:release:win
